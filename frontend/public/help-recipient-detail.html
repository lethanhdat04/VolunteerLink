<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết yêu cầu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body data-role="RECIPIENT">


<div class="container my-4">
    <h2 class="text-center mb-4">Chi tiết yêu cầu</h2>

    <!-- Spinner loading -->
    <div id="loadingDetail" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p>Đang tải chi tiết…</p>
    </div>

    <!-- Nội dung chi tiết -->
    <div id="detailContent" style="display: none;">
        <div class="card mb-4">
            <div class="card-body" id="staticView">
                <h4 id="detailTitle">–</h4>
                <p><strong>Mô tả:</strong> <span id="detailDescription">–</span></p>
                <p><strong>Địa điểm:</strong> <span id="detailLocation">–</span></p>
                <p><strong>Kỹ năng yêu cầu:</strong> <span id="detailSkills">–</span></p>
                <p><strong>Cấp độ gấp:</strong> <span id="detailUrgency">–</span></p>
                <p>
                    <strong>Trạng thái:</strong>
                    <span id="detailStatus" class="badge">–</span>
                </p>
                <p>
                    <strong>Volunteer:</strong>
                    <span id="detailVolunteer">–</span>
                </p>
                <p><strong>Ngày tạo:</strong> <span id="detailDate">–</span></p>
            </div>

            <div class="card-body" id="editView" style="display: none;">
                <form id="editForm">
                    <div class="mb-3">
                        <label for="inputTitle" class="form-label">Tiêu đề</label>
                        <input type="text" id="inputTitle" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="inputDescription" class="form-label">Mô tả</label>
                        <textarea id="inputDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="inputLocation" class="form-label">Địa điểm</label>
                        <input type="text" id="inputLocation" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="inputSkills" class="form-label">Kỹ năng yêu cầu (phân cách dấu phẩy)</label>
                        <input type="text" id="inputSkills" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="selectUrgency" class="form-label">Cấp độ gấp</label>
                        <select id="selectUrgency" class="form-select" required>
                            <option value="HIGH">Cao</option>
                            <option value="MEDIUM">Trung bình</option>
                            <option value="LOW">Thấp</option>
                        </select>
                    </div>
                    <!-- Volunteer không cho chỉnh sửa -->
                    <div class="mb-3">
                        <label class="form-label">Volunteer</label>
                        <input type="text" id="inputVolunteer" class="form-control" readonly>
                    </div>
                    <div class="text-end">
                        <button type="button" id="btnCancelEdit" class="btn btn-secondary me-2">Hủy</button>
                        <button type="submit" class="btn btn-success">Lưu</button>
                    </div>
                    <div id="updateMessage" class="mt-3 text-center"></div>
                </form>
            </div>
        </div>

        <!-- Nút chỉnh sửa -->
        <div class="text-end mb-4">
            <button id="btnEdit" class="btn btn-warning">Chỉnh sửa yêu cầu</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('Bạn chưa đăng nhập hoặc phiên đã hết hạn.');
            return;
        }

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        if (!id) {
            alert('Không xác định được ID yêu cầu.');
            return;
        }

        // Fetch chi tiết yêu cầu
        let reqData;
        try {
            const res = await fetch(`https://162544f1-b989-4423-9195-385f0fdd93b3.mock.pstmn.io/requestsRecipient/${encodeURIComponent(id)}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
            });
            if (!res.ok) {
                console.error('Lỗi khi lấy chi tiết yêu cầu:', res.status);
                return;
            }
            reqData = await res.json();
        } catch (err) {
            console.error('Không thể kết nối API chi tiết yêu cầu:', err);
            return;
        }

        // Hiển thị phần static
        document.getElementById('loadingDetail').style.display = 'none';
        document.getElementById('detailContent').style.display = 'block';

        // Đổ dữ liệu ra phần static
        document.getElementById('detailTitle').textContent = reqData.title;
        document.getElementById('detailDescription').textContent = reqData.description;
        document.getElementById('detailLocation').textContent = reqData.location;
        document.getElementById('detailSkills').textContent = reqData.requiredSkills.join(', ');
        document.getElementById('detailUrgency').textContent = reqData.urgencyLevel;
        document.getElementById('detailStatus').textContent = reqData.status;
        document.getElementById('detailStatus').className = 'badge ' + getBadgeClass(reqData.status);
        document.getElementById('detailVolunteer').textContent =
            (reqData.volunteerId && reqData.volunteerId !== 0) ? (reqData.Namevolunteer || '–') : 'Chưa có';
        document.getElementById('detailDate').textContent = formatDate(reqData.createdAt);

        // Chuẩn bị dữ liệu cho form edit
        const inputTitle = document.getElementById('inputTitle');
        const inputDescription = document.getElementById('inputDescription');
        const inputLocation = document.getElementById('inputLocation');
        const inputSkills = document.getElementById('inputSkills');
        const selectUrgency = document.getElementById('selectUrgency');
        const inputVolunteer = document.getElementById('inputVolunteer');
        const updateMessage = document.getElementById('updateMessage');
        const staticView = document.getElementById('staticView');
        const editView = document.getElementById('editView');

        function populateEditForm() {
            inputTitle.value = reqData.title;
            inputDescription.value = reqData.description;
            inputLocation.value = reqData.location;
            inputSkills.value = reqData.requiredSkills.join(', ');
            selectUrgency.value = reqData.urgencyLevel;
            inputVolunteer.value = (reqData.volunteerId && reqData.volunteerId !== 0)
                ? (reqData.Namevolunteer || '')
                : 'Chưa có';
        }

        // Khi nhấn nút Chỉnh sửa
        document.getElementById('btnEdit').onclick = () => {
            if (reqData.status !== 'PENDING') {
                alert('Chỉ có thể chỉnh sửa khi trạng thái là PENDING.');
                return;
            }
            populateEditForm();
            staticView.style.display = 'none';
            editView.style.display = 'block';
            document.getElementById('btnEdit').style.display = 'none';
        };

        // Nút Hủy chỉnh sửa
        document.getElementById('btnCancelEdit').onclick = () => {
            editView.style.display = 'none';
            staticView.style.display = 'block';
            document.getElementById('btnEdit').style.display = 'inline-block';
            updateMessage.textContent = '';
        };

        // Xử lý submit form edit
        document.getElementById('editForm').onsubmit = async (ev) => {
            ev.preventDefault();
            updateMessage.textContent = '';

            const payload = {
                title: inputTitle.value.trim(),
                description: inputDescription.value.trim(),
                location: inputLocation.value.trim(),
                requiredSkills: inputSkills.value.split(',').map(s => s.trim()),
                urgencyLevel: selectUrgency.value
            };

            try {
                const resUpdate = await fetch(`https://162544f1-b989-4423-9195-385f0fdd93b3.mock.pstmn.io/requestsRecipient/${encodeURIComponent(id)}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                if (!resUpdate.ok) {
                    throw new Error(`Lỗi ${resUpdate.status}`);
                }
                const updated = await resUpdate.json();
                reqData = updated; // cập nhật lại dữ liệu cục bộ

                // Cập nhật hiển thị static ngay lập tức
                document.getElementById('detailTitle').textContent = updated.title;
                document.getElementById('detailDescription').textContent = updated.description;
                document.getElementById('detailLocation').textContent = updated.location;
                document.getElementById('detailSkills').textContent = updated.requiredSkills.join(', ');
                document.getElementById('detailUrgency').textContent = updated.urgencyLevel;

                updateMessage.innerHTML = '<div class="alert alert-success">Cập nhật thành công.</div>';
                setTimeout(() => {
                    updateMessage.textContent = '';
                    editView.style.display = 'none';
                    staticView.style.display = 'block';
                    document.getElementById('btnEdit').style.display = 'inline-block';
                }, 1000);
            } catch (err) {
                console.error('Lỗi khi cập nhật yêu cầu:', err);
                updateMessage.innerHTML =
                    `<div class="alert alert-danger">Cập nhật thất bại: ${err.message}</div>`;
            }
        };

        function getBadgeClass(status) {
            switch (status) {
                case 'PENDING':   return 'bg-warning text-dark';
                case 'ACCEPTED':  return 'bg-primary text-white';
                case 'COMPLETED': return 'bg-success text-white';
                case 'CANCELLED': return 'bg-secondary text-white';
                default:          return 'bg-light text-dark';
            }
        }

        function formatDate(iso) {
            const d = new Date(iso);
            return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
        }
    });
</script>
<script src="auth.js"></script>
</body>
</html>
