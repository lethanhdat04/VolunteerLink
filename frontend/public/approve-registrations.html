<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Duyệt đăng ký tình nguyện viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand organization" href="dashboard-organization.html">Organization</a>
        <div class="collapse navbar-collapse" id="orgNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="dashboard-organization.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="manage-events.html">Quản lý sự kiện</a></li>
                <li class="nav-item"><a class="nav-link" href="approve-registrations.html">Duyệt đăng ký</a></li>
                <li class="nav-item"><a class="nav-link" href="stats-organization.html">Thống kê</a></li>
                <li class="nav-item"><a class="nav-link" href="notifications-organization.html">Thông báo</a></li>
                <li class="nav-item"><a class="nav-link" href="org-profile.html">Hồ sơ</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container my-4">
    <h2 class="text-center mb-4">Duyệt đăng ký tình nguyện viên</h2>
    <table class="table table-hover">
        <thead>
        <tr>
            <th>ID</th>
            <th>Tình nguyện viên</th>
            <th>Sự kiện</th>
            <th>Ngày đăng ký</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody id="regTable"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const orgId = 1;

    async function updateReg(id, status, eventTitle, volId) {
        // Cập nhật registration
        await fetch(`/registrations/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });

        // Tạo notification
        const now = new Date().toISOString();
        const content = status === 'CONFIRMED'
            ? `Bạn đã được <strong style=\"color:blue\">chấp nhận</strong> tham gia sự kiện "${eventTitle}"`
            : `Bạn đã bị <strong style=\"color:red\">từ chối</strong> tham gia sự kiện "${eventTitle}"`;

        await fetch('/notifications', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                recipientId: volId,
                senderId: orgId,
                title: 'Trạng thái đăng ký',
                content,
                type: 'SYSTEM',
                status: 'UNREAD',
                createdDate: now
            })
        });

        // Cập nhật lại bảng
        loadRegistrations();
    }

    async function loadRegistrations() {
        const evs = await fetch(`/events?organizationId=${orgId}`).then(r => r.json());
        const eventMap = Object.fromEntries(evs.map(e => [e.id, e.title]));

        const vols = await fetch('/volunteers').then(r => r.json());
        const volMap = Object.fromEntries(vols.map(v => [v.id, v.fullName]));

        const regs = await fetch('/registrations?status=REGISTERED').then(r => r.json());
        const filtered = regs.filter(r => eventMap[r.eventId]);

        const tb = document.getElementById('regTable');
        tb.innerHTML = '';

        filtered.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td>${r.id}</td>
          <td>${volMap[r.volunteerId] || r.volunteerId}</td>
          <td>${eventMap[r.eventId]}</td>
          <td>${new Date(r.registrationDate).toLocaleDateString('vi-VN')}</td>
          <td>
            <button class="btn btn-sm btn-success btn-approve"
                    data-id="${r.id}" data-event="${eventMap[r.eventId]}" data-vol="${r.volunteerId}">Chấp nhận</button>
            <button class="btn btn-sm btn-danger btn-reject"
                    data-id="${r.id}" data-event="${eventMap[r.eventId]}" data-vol="${r.volunteerId}">Từ chối</button>
          </td>`;
            tb.appendChild(tr);
        });

        // Gán sự kiện cho các nút
        document.querySelectorAll('.btn-approve').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                const evt = btn.getAttribute('data-event');
                const vol = btn.getAttribute('data-vol');
                updateReg(id, 'CONFIRMED', evt, parseInt(vol));
            });
        });
        document.querySelectorAll('.btn-reject').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                const evt = btn.getAttribute('data-event');
                const vol = btn.getAttribute('data-vol');
                updateReg(id, 'NO_SHOW', evt, parseInt(vol));
            });
        });
    }

    // Khởi tạo
    loadRegistrations();
</script>
</body>
</html>
