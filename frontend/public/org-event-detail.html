<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết sự kiện (Tổ chức)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
</head>
<body data-role="ORGANIZATION">
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand organization" href="dashboard-organization.html">Organization</a>
        <div class="collapse navbar-collapse" id="orgNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="dashboard-organization.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="manage-events.html">Quản lý sự kiện</a></li>
                <li class="nav-item"><a class="nav-link" href="approve-registrations.html">Duyệt đăng ký</a></li>
                <li class="nav-item"><a class="nav-link" href="stats-organization.html">Thống kê</a></li>
                <li class="nav-item"><a class="nav-link" href="org-profile.html">Hồ sơ</a></li>
            </ul>
        </div>
        <a class="nav-link" href="#" id="btnLogout"><span class="material-symbols-outlined">logout</span></a>
    </div>
</nav>

<div class="container my-4">
    <h2 id="evtTitle" class="mb-4"></h2>

    <ul class="nav nav-tabs">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#info">Thông tin sự kiện</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#regs">Đăng ký</button>
        </li>
    </ul>

    <div class="tab-content p-3 border border-top-0">
        <div id="info" class="tab-pane fade show active">
            <form id="editEvtForm">
                <input type="hidden" name="id" id="eventId">
                <input type="hidden" name="organizationId" value="1">
                <div class="mb-3">
                    <label class="form-label">Tiêu đề</label>
                    <input type="text" class="form-control" name="title" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Mô tả</label>
                    <textarea class="form-control" name="description" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Địa điểm</label>
                    <input type="text" class="form-control" name="location">
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Bắt đầu</label>
                        <input type="datetime-local" class="form-control" name="startTime">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Kết thúc</label>
                        <input type="datetime-local" class="form-control" name="endTime">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Kỹ năng yêu cầu</label>
                    <input type="text" class="form-control" name="requiredSkills" placeholder="phân cách bằng dấu phẩy">
                </div>
                <div class="mb-3">
                    <label class="form-label">Số tối đa</label>
                    <input type="number" class="form-control" name="maxParticipants">
                </div>
                <div class="mb-3">
                    <label class="form-label">Trạng thái</label>
                    <select class="form-select" name="status">
                        <option>PLANNED</option>
                        <option>ONGOING</option>
                        <option>COMPLETED</option>
                        <option>CANCELLED</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Lưu thay đổi</button>
            </form>
        </div>

        <div id="regs" class="tab-pane fade">
            <h5 class="mb-3">Danh sách đăng ký (đã xác nhận)</h5>
            <ul class="list-group" id="regList"></ul>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (async () => {
        const orgId = 1;
        const eventId = new URLSearchParams(window.location.search).get('id');

        // Lấy chi tiết event
        const res = await fetch(`/events/${eventId}`);
        if (!res.ok) {
            document.querySelector('.container').innerHTML = '<div class="alert alert-danger">Không tìm thấy sự kiện.</div>';
            return;
        }
        const e = await res.json();

        if (e.organizationId != orgId) {
            document.body.innerHTML = '<div class="alert alert-danger">Bạn không có quyền truy cập.</div>';
            return;
        }

        // Hiển thị title
        document.getElementById('evtTitle').textContent = e.title;

        // Điền form
        document.getElementById('eventId').value = e.id;
        const form = document.getElementById('editEvtForm');
        form.title.value = e.title;
        form.description.value = e.description;
        form.location.value = e.location;
        form.startTime.value = e.startTime;
        form.endTime.value = e.endTime;
        form.requiredSkills.value = e.requiredSkills.join(', ');
        form.maxParticipants.value = e.maxParticipants;
        form.status.value = e.status;

        // Submit form
        form.addEventListener('submit', async ev => {
            ev.preventDefault();
            const data = Object.fromEntries(new FormData(form));
            data.requiredSkills = data.requiredSkills.split(',').map(s => s.trim());
            await fetch(`/events/${eventId}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            alert('Cập nhật thành công');
            location.reload();
        });

        // Hiển thị list regs
        const regs = await fetch(`/registrations?eventId=` + eventId + `&status=CONFIRMED`).then(r => r.json());
        const list = document.getElementById('regList');
        if (!regs.length) {
            list.innerHTML = '<li class="list-group-item">Chưa có đăng ký nào.</li>';
        } else {
            regs.forEach(r => {
                list.innerHTML += `<li class="list-group-item">Volunteer ${r.volunteerId} – ${new Date(r.registrationDate).toLocaleDateString('vi-VN')}</li>`;
            });
        }

    })();
</script>
<script src="auth.js"></script>
</body>
</html>
