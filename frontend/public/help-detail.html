<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết yêu cầu trợ giúp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .badge-urgency { text-transform: uppercase; }
    </style>
</head>
<body>
<div class="container my-4" id="helpContainer">
    <a href="help-requests-list.html" class="btn btn-link">&larr; Quay lại</a>

    <!-- Spinner loading -->
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p>Đang tải…</p>
    </div>

    <!-- Nội dung chi tiết -->
    <div id="helpDetail" style="display:none;">
        <h2 id="title"></h2>
        <p><strong>Địa điểm:</strong> <span id="location"></span></p>
        <p><strong>Mô tả:</strong> <span id="description"></span></p>

        <p><strong>Kỹ năng yêu cầu:</strong></p>
        <ul id="requiredSkills"></ul>

        <p>
            <strong>Cấp độ gấp:</strong>
            <span id="urgency" class="badge badge-urgency"></span>
        </p>

        <p><strong>Trạng thái:</strong> <span id="status"></span></p>
        <p><strong>Volunteer nhận:</strong> <span id="volunteerId"></span></p>

        <!-- Nút nhận nhiệm vụ -->
        <div id="actionArea" class="mt-4">
            <button id="acceptBtn" class="btn btn-success">Nhận nhiệm vụ</button>
        </div>
    </div>
</div>

<script>
    (async function(){
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id') || 1;

        try {
            // 1) Lấy chi tiết helpRequest
            const res = await fetch(`http://localhost:3000/helpRequests/${id}`);
            if (!res.ok) throw new Error('Không tìm thấy yêu cầu');
            const h = await res.json();

            // 2) Đổ dữ liệu lên DOM
            document.getElementById('title').textContent       = h.title;
            document.getElementById('location').textContent    = h.location;
            document.getElementById('description').textContent = h.description;
            document.getElementById('status').textContent      = h.status;

            // Kỹ năng
            const ul = document.getElementById('requiredSkills');
            ul.innerHTML = '';
            h.requiredSkills.forEach(skill => {
                const li = document.createElement('li');
                li.textContent = skill;
                ul.appendChild(li);
            });

            // Cấp độ gấp
            const urg = document.getElementById('urgency');
            urg.textContent = h.urgencyLevel;
            if (h.urgencyLevel === 'HIGH')        urg.classList.add('bg-danger','text-white');
            else if (h.urgencyLevel === 'MEDIUM') urg.classList.add('bg-warning','text-dark');
            else                                  urg.classList.add('bg-info','text-white');

            // Volunteer nhận
            const volEl = document.getElementById('volunteerId');
            if (h.volunteerId && h.volunteerId !== 0) {
                volEl.textContent = h.volunteerId;
            } else {
                volEl.textContent = 'Chưa có ai nhận';
                volEl.classList.add('text-muted');
            }

            // 3) Ẩn spinner, hiện detail
            document.getElementById('loading').style.display     = 'none';
            document.getElementById('helpDetail').style.display  = 'block';

            // 4) Thiết lập listener cho nút Nhận nhiệm vụ
            const btn = document.getElementById('acceptBtn');
            if (!h.volunteerId || h.volunteerId === 0) {
                btn.addEventListener('click', async () => {
                    btn.disabled   = true;
                    btn.textContent = 'Đang gửi…';
                    const now = new Date().toISOString();

                    try {
                        // 4.1) PATCH helpRequest
                        const patchRes = await fetch(`http://localhost:3000/helpRequests/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ volunteerId: 1, status: 'ACCEPTED' })
                        });
                        if (!patchRes.ok) throw new Error('Cập nhật thất bại');

                        // 4.2) POST notification
                        const notif = {
                            recipientId: 1,
                            senderId:    1000,
                            title:       'Thông báo hệ thống',
                            content:     `Bạn đã đăng ký nhận "${h.title}" thành công`,
                            type:        'SYSTEM',
                            status:      'UNREAD',
                            createdDate: now
                        };
                        const notifRes = await fetch('http://localhost:3000/notifications', {
                            method: 'POST',
                            headers:{ 'Content-Type':'application/json' },
                            body: JSON.stringify(notif)
                        });
                        if (!notifRes.ok) throw new Error('Không tạo được thông báo');

                        // 4.3) Cập nhật UI
                        btn.textContent = 'Đã nhận';
                        document.getElementById('volunteerId').textContent = '1';
                        document.getElementById('status').textContent      = 'ACCEPTED';
                    } catch(err) {
                        btn.disabled    = false;
                        btn.textContent = 'Nhận nhiệm vụ';
                        alert('Lỗi: ' + err.message);
                    }
                });
            } else {
                // Nếu đã nhận rồi, ẩn luôn nút
                document.getElementById('actionArea').style.display = 'none';
            }

        } catch(err) {
            document.getElementById('loading').innerHTML =
                `<div class="alert alert-danger">Lỗi: ${err.message}</div>`;
        }
    })();
</script>
</body>
</html>
