<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết sự kiện</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>.badge-status { text-transform:uppercase; }</style>
</head>
<body>

<div class="container my-4" id="event-container">
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary"></div>
        <p>Đang tải…</p>
    </div>

    <div id="event-detail" class="row" style="display:none;">
        <!-- ... phần hiển thị event như trước ... -->
        <div class="col-md-5">
            <!-- ... -->
            <form id="registrationForm">
                <button type="submit" class="btn btn-success w-100">Đăng ký</button>
            </form>
            <div id="regMessage" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
    (async()=>{
        const volunteerId = 1;
        const params = new URLSearchParams(location.search);
        const eventId = params.get('id');

        // 1) Lấy event + organization + volunteer
        const [e, org, volunteer] = await Promise.all([
            fetch(`/events/${eventId}`).then(r=>r.json()),
            fetch(`/events/${eventId}`).then(r=>r.json()).then(ev=>fetch(`/organizations/${ev.organizationId}`).then(r=>r.json())),
            fetch(`/volunteers/${volunteerId}`).then(r=>r.json())
        ]);

        // ... phần điền thông tin sự kiện ...

        // 2) Kiểm xem đã đăng ký chưa
        const existing = await fetch(`/registrations?eventId=${eventId}&volunteerId=${volunteerId}`)
            .then(r=>r.json());
        if (existing.length) {
            document.getElementById('registrationForm').style.display = 'none';
            document.getElementById('regMessage').innerHTML =
                `<div class="alert alert-warning">Bạn đã đăng ký tham gia sự kiện này.</div>`;
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('event-detail').style.display = 'flex';

        // 3) Xử lý nút Đăng ký
        document.getElementById('registrationForm').onsubmit = async ev => {
            ev.preventDefault();
            const now = new Date().toISOString();

            // Tạo đăng ký
            await fetch('/registrations', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    eventId: e.id,
                    volunteerId,
                    registrationDate: now,
                    status: 'REGISTERED',
                    rating: 0
                })
            });

            // Thông báo cho volunteer
            await fetch('/notifications', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    recipientId: volunteer.accountId,
                    senderId: 0,
                    title: 'Đăng ký sự kiện',
                    content: `Bạn đã đăng ký tham gia sự kiện "${e.title}"`,
                    type: 'SYSTEM',
                    status: 'UNREAD',
                    createdDate: now
                })
            });

            // Thông báo cho tổ chức
            await fetch('/notifications', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    recipientId: org.accountId,
                    senderId: volunteer.accountId,
                    title: e.title,
                    content: `${volunteer.fullName} đã đăng ký tham gia sự kiện của bạn`,
                    type: 'EVENT',
                    status: 'UNREAD',
                    createdDate: now
                })
            });

            document.getElementById('registrationForm').style.display = 'none';
            document.getElementById('regMessage').innerHTML =
                `<div class="alert alert-success">Đăng ký thành công!</div>`;
        };
    })();
</script>
</body>
</html>
