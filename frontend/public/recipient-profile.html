<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Hồ sơ Recipient</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
</head>
<body data-role="RECIPIENT">
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand recipient" href="dashboard-recipient.html">Recipient</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard-recipient.html">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="requests-recipient.html">Yêu cầu trợ giúp</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="recipient-profile.html">Hồ sơ</a>
                </li>
            </ul>
        </div>
        <a class="nav-link" href="#" id="btnLogout">
            <span class="material-symbols-outlined">logout</span>
        </a>
    </div>
</nav>

<div class="container my-5">
    <h2 class="profile-title text-center mb-5">Hồ sơ cá nhân</h2>

    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p>Đang tải thông tin…</p>
    </div>

    <div id="profileContent" class="profile-wrapper" style="display: none;">
        <div class="profile-left">
            <img
                    src="images/avatar.jpg"
                    alt="Avatar"
                    id="avatarImg"
                    class="profile-avatar"
            />
            <h3 id="fullNameDisplay" class="profile-name">–</h3>
            <span id="roleDisplay" class="profile-role">–</span>
        </div>

        <div class="profile-right">
            <div id="staticInfo">
                <div class="row gx-4">
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary">Tên đăng nhập:</label>
                        <div>
                            <span id="staticUsername">–</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary">Email:</label>
                        <div>
                            <span id="staticEmail">–</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary">Họ và tên:</label>
                        <div>
                            <span id="staticFullName">–</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary">Số điện thoại:</label>
                        <div>
                            <span id="staticPhoneNumber">–</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary">Địa chỉ:</label>
                        <div>
                            <span id="staticAddress">–</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary">Status:</label>
                        <div>
                            <span id="staticStatus" class="badge bg-success">–</span>
                        </div>
                    </div>
                </div>
                <button id="btnEdit" class="btn btn-warning w-100">Cập nhật</button>
            </div>

            <div id="editFormWrapper" class="profile-form-wrapper" style="display: none;">
                <form id="profileForm" class="profile-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Tên đăng nhập</label>
                        <input type="text" class="form-control" id="username" name="username" required />
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required />
                    </div>
                    <div class="mb-3">
                        <label for="fullName" class="form-label">Họ và tên</label>
                        <input type="text" class="form-control" id="fullName" name="fullName" required />
                    </div>
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Số điện thoại</label>
                        <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" />
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Địa chỉ</label>
                        <input type="text" class="form-control" id="address" name="address" />
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="ACTIVE">ACTIVE</option>
                            <option value="INACTIVE">INACTIVE</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" id="btnCancel" class="btn btn-secondary">Hủy</button>
                        <button type="submit" class="btn btn-success">Lưu</button>
                    </div>
                    <div id="updateMessage" class="mt-3 text-center"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const loadingEl = document.getElementById('loading');
        const contentEl = document.getElementById('profileContent');
        const fullNameDisplay = document.getElementById('fullNameDisplay');
        const roleDisplay = document.getElementById('roleDisplay');

        const staticUsername = document.getElementById('staticUsername');
        const staticEmail = document.getElementById('staticEmail');
        const staticFullName = document.getElementById('staticFullName');
        const staticPhoneNumber = document.getElementById('staticPhoneNumber');
        const staticAddress = document.getElementById('staticAddress');
        const staticStatus = document.getElementById('staticStatus');

        const btnEdit = document.getElementById('btnEdit');
        const editFormWrapper = document.getElementById('editFormWrapper');
        const staticInfo = document.getElementById('staticInfo');
        const updateMsgEl = document.getElementById('updateMessage');

        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');
        const fullNameInput = document.getElementById('fullName');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const addressInput = document.getElementById('address');
        const statusInput = document.getElementById('status');

        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('Bạn chưa đăng nhập hoặc phiên đã hết hạn.');
            return;
        }

        let recipientData;
        try {
            const res = await fetch('https://162544f1-b989-4423-9195-385f0fdd93b3.mock.pstmn.io/recipientinf', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) {
                console.error('Lỗi khi lấy thông tin recipient:', res.status);
                alert('Không thể tải thông tin hồ sơ.');
                return;
            }
            recipientData = await res.json();
        } catch (err) {
            console.error('Lỗi kết nối khi lấy recipient info:', err);
            alert('Không thể kết nối tới server.');
            return;
        } finally {
            loadingEl.style.display = 'none';
            contentEl.style.display = 'flex';
        }

        fullNameDisplay.textContent = recipientData.fullname || '';
        roleDisplay.textContent = 'RECIPIENT';

        staticUsername.textContent    = recipientData.username || '';
        staticEmail.textContent       = recipientData.email || '';
        staticFullName.textContent    = recipientData.fullname || '';
        staticPhoneNumber.textContent = recipientData.phoneNumber || '';
        staticAddress.textContent     = recipientData.address || '';
        staticStatus.textContent      = recipientData.status || '–';
        staticStatus.classList.toggle(
            recipientData.status === 'ACTIVE' ? 'bg-success' : 'bg-danger',
            true
        );

        btnEdit.addEventListener('click', () => {
            staticInfo.style.display = 'none';
            editFormWrapper.style.display = 'block';

            usernameInput.value    = recipientData.username || '';
            emailInput.value       = recipientData.email || '';
            fullNameInput.value    = recipientData.fullname || '';
            phoneNumberInput.value = recipientData.phoneNumber || '';
            addressInput.value     = recipientData.address || '';
            statusInput.value      = recipientData.status || 'ACTIVE';
        });

        document.getElementById('btnCancel').addEventListener('click', () => {
            editFormWrapper.style.display = 'none';
            staticInfo.style.display = 'block';
            updateMsgEl.innerHTML = '';
        });

        document.getElementById('profileForm').addEventListener('submit', async function (ev) {
            ev.preventDefault();
            updateMsgEl.textContent = '';

            const dataToUpdate = {
                username:    usernameInput.value.trim(),
                email:       emailInput.value.trim(),
                fullname:    fullNameInput.value.trim(),
                phoneNumber: phoneNumberInput.value.trim(),
                address:     addressInput.value.trim(),
                status:      statusInput.value
            };

            try {
                const resUpdate = await fetch('https://162544f1-b989-4423-9195-385f0fdd93b3.mock.pstmn.io/recipientinf', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dataToUpdate)
                });
                if (!resUpdate.ok) {
                    throw new Error(`Lỗi ${resUpdate.status}`);
                }
                const updated = await resUpdate.json();
                recipientData = updated;

                staticUsername.textContent    = updated.username;
                staticEmail.textContent       = updated.email;
                staticFullName.textContent    = updated.fullname;
                staticPhoneNumber.textContent = updated.phoneNumber;
                staticAddress.textContent     = updated.address;
                staticStatus.textContent      = updated.status;
                staticStatus.classList.toggle(
                    updated.status === 'ACTIVE' ? 'bg-success' : 'bg-danger',
                    true
                );

                updateMsgEl.innerHTML = '<div class="alert alert-success">Cập nhật thành công.</div>';
                setTimeout(() => {
                    editFormWrapper.style.display = 'none';
                    staticInfo.style.display = 'block';
                    updateMsgEl.innerHTML = '';
                }, 1000);
            } catch (err) {
                console.error('Lỗi khi cập nhật recipient info:', err);
                updateMsgEl.innerHTML =
                    `<div class="alert alert-danger">Cập nhật thất bại: ${err.message}</div>`;
            }
        });
    });
</script>
<script src="auth.js"></script>
</body>
</html>
